<?php

namespace App\Livewire\Professional;

use App\Models\Professional\ProfessionalService;
use App\Models\Service;
use App\Models\ServiceCategory;
use Illuminate\Support\Facades\Auth;
use Livewire\Component;

class EditServices extends Component
{
    public ProfessionalService $proService;
    // public $proService;
    public $categories = [];
    public $services = [];
    public string $selectedCategory;
    public string $selectedService;
    public string $selectedTimeFrom;
    public string $selectedTimeTo;
    public string $price;
    public string $serviceDescription;

    public function mount(ProfessionalService $proService)
    {
        // dd($service);
        $professionalId = Auth::user()->professional->id;

        // $this->proService = $proService->where('professional_id',$professionalId);
        $this->proService = ProfessionalService::where('professional_id', $professionalId)
                                            ->where('id', $proService->id)
                                            ->first();

        dd($this->proService);
        // dd($this->proService);

        $this->categories = ServiceCategory::all();
        $this->selectedCategory = $this->proService->service_category_id ?? '';
        // dd($this->proService->service_category_id);
        $this->selectedService = $this->proService->service_id ?? '';
        $this->selectedTimeFrom = $this->proService->business_hours_start ?? '';
        // dd($this->selectedTimeFrom);
        $this->selectedTimeTo = $this->proService->business_hours_end ?? '';
        $this->price = $this->proService->price ?? '';
        // dd($this->price);
        $this->serviceDescription = $this->proService->description ?? '';
        // dd($this->all());

        // if ($this->selectedCategory !== '') {
        //     $this->services = Service::where('service_category_id', $this->selectedCategory)->get();
        // }
    }


    public function changeCategory()
    {
        if ($this->selectedCategory != -1) {
            $this->services = Service::where('service_category_id', $this->selectedCategory)->get();
        }
    }

    public function update()
    {
        $this->validate([
            'selectedCategory' => 'required',
            'selectedService' => 'required',
            'selectedTimeFrom' => 'required',
            'selectedTimeTo' => 'required',
            'price' => 'required|numeric',
            'serviceDescription' => 'required',
        ]);

        // Find the ProfessionalService record by ID
        $proService = ProfessionalService::find($this->proService->id);

        // Update the record with the new data
        $proService->update([
            'service_category_id' => $this->selectedCategory,
            'service_id' => $this->selectedService,
            'business_hours_from' => $this->selectedTimeFrom,
            'business_hours_to' => $this->selectedTimeTo,
            'price' => $this->price,
            'description' => $this->serviceDescription,
        ]);

        // Optional: You can add a success message or redirect to a different page
        session()->flash('message', 'Service updated successfully!');

        // Refresh the component to reflect the changes
        $this->mount($proService);
    }

    public function render()
    {
        return view('livewire.professional.edit-services');
    }
}
